# ✅订单模块设计



订单模块，是我们的项目中最重要的一个模块了，他的职责主要就是提供订单相关的管理和查询等功能。













![img](https://cdn.nlark.com/yuque/0/2024/png/5378072/1718108733847-8b9ae4a2-72d0-4561-9316-f320748973a1.png)











这个模块我们按照功能分别介绍











## 模型设计







![img](https://cdn.nlark.com/yuque/0/2024/jpeg/5378072/1721538511200-fe9b4d0b-078b-4db8-9807-5b20e4fba616.jpeg)











## 状态机













![img](https://cdn.nlark.com/yuque/0/2024/jpeg/5378072/1718110811771-e10b1832-bad2-4d3c-a9d9-7b7433a4c894.jpeg)















##### ✅订单为什么没有 PAYING 状态？

这是我们的订单的状态机，为什么没有PAYING 状态表示支付中呢？ 其实没有任何必要，反而会带来很多问题： 因为订单的支付可能发起多次，因为用户可能会不同的渠道支付，也可能取消支付在发起一次，那么这个状态就需要不断变化，从 CONFIRM 

NFTurbo文档









## 业务流程





### 下单











**方案一、基于InventoryHint**















##### ✅基于InventoryHint实现库存的热点扣减

我们的库存扣减，是基于 Redis+数据库的，先在 Redis 中做预扣减，然后再在数据库中做扣减。 但是我们有一种方案是没用 MQ的，而是在数据库中用了InventoryHint，他可以帮我们抗高并发的热点更新。  以上是整体的交互图，下

NFTurbo文档











![img](https://cdn.nlark.com/yuque/__puml/8783cb2953ae65163d5ec05374af4357.svg)











这里关于库存扣减部分大家直接看库存相关设计即可，订单部分我们重点介绍下。











这部分，我们在订单扣减的时候，用了一个自发自收的内部事件，这个事件主要起到一个缓冲的作用，另外，也是适当的解耦。











这里没用 RocketMQ，而是用了 Spring的Event 机制+XXLJOB 重试来保障的。











这部分成功之后，订单状态会变成 CONFIRM，这个状态下的订单就可以支付了。











**方案二、基于 RocketMQ**











这个方案主要针对如果数据库不支持 InventoryHint 的话，我们采用 RocketMQ 来进行解耦和削峰填谷。













![img](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%221088px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A1033px%3Bheight%3A1088px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%201033%201088%22%20width%3D%221033px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22907.4531%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%2217%22%20y%3D%2291.2969%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2222%22%20x2%3D%2222%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2290%22%20x2%3D%2290%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22307.5%22%20x2%3D%22307.5%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22465%22%20x2%3D%22465%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22567%22%20x2%3D%22567%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22742.5%22%20x2%3D%22742.5%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22847.5%22%20x2%3D%22847.5%22%20y1%3D%2281.2969%22%20y2%3D%221007.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2228%22%20x%3D%225%22%20y%3D%2277.9951%22%3E%26%2329992%3B%26%2325143%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2222%22%20cy%3D%2213.5%22%20fill%3D%22%23E2E2F0%22%20rx%3D%228%22%20ry%3D%228%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M22%2C21.5%20L22%2C48.5%20M9%2C29.5%20L35%2C29.5%20M22%2C48.5%20L9%2C63.5%20M22%2C48.5%20L35%2C63.5%20%22%20fill%3D%22none%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2228%22%20x%3D%225%22%20y%3D%221019.7451%22%3E%26%2329992%3B%26%2325143%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2222%22%20cy%3D%221031.5469%22%20fill%3D%22%23E2E2F0%22%20rx%3D%228%22%20ry%3D%228%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M22%2C1039.5469%20L22%2C1066.5469%20M9%2C1047.5469%20L35%2C1047.5469%20M22%2C1066.5469%20L9%2C1081.5469%20M22%2C1066.5469%20L35%2C1081.5469%20%22%20fill%3D%22none%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%2262%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%2269%22%20y%3D%2269.9951%22%3E%26%2327983%3B%26%2335272%3B%26%2322120%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%2262%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%2269%22%20y%3D%221026.7451%22%3E%26%2327983%3B%26%2335272%3B%26%2322120%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2275%22%20x%3D%22270.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2261%22%20x%3D%22277.5%22%20y%3D%2269.9951%22%3Enft_trade%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2275%22%20x%3D%22270.5%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2261%22%20x%3D%22277.5%22%20y%3D%221026.7451%22%3Enft_trade%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2280%22%20x%3D%22425%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2266%22%20x%3D%22432%22%20y%3D%2269.9951%22%3Erocketmq%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2280%22%20x%3D%22425%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2266%22%20x%3D%22432%22%20y%3D%221026.7451%22%3Erocketmq%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22105%22%20x%3D%22515%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22522%22%20y%3D%2269.9951%22%3Enft_collection%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22105%22%20x%3D%22515%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22522%22%20y%3D%221026.7451%22%3Enft_collection%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2248%22%20x%3D%22718.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2234%22%20x%3D%22725.5%22%20y%3D%2269.9951%22%3Eredis%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2248%22%20x%3D%22718.5%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2234%22%20x%3D%22725.5%22%20y%3D%221026.7451%22%3Eredis%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2276%22%20x%3D%22809.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2262%22%20x%3D%22816.5%22%20y%3D%2269.9951%22%3Enft_order%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2276%22%20x%3D%22809.5%22%20y%3D%221006.75%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2262%22%20x%3D%22816.5%22%20y%3D%221026.7451%22%3Enft_order%3C%2Ftext%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22907.4531%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%2217%22%20y%3D%2291.2969%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2278%2C108.4297%2C88%2C112.4297%2C78%2C116.4297%2C82%2C112.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2227%22%20x2%3D%2284%22%20y1%3D%22112.4297%22%20y2%3D%22112.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%2234%22%20y%3D%22107.3638%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2226%22%20x%3D%2247%22%20y%3D%22107.3638%22%3E%26%2319979%3B%26%2321333%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22296%2C137.5625%2C306%2C141.5625%2C296%2C145.5625%2C300%2C141.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2290%22%20x2%3D%22302%22%20y1%3D%22141.5625%22%20y2%3D%22141.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%2297%22%20y%3D%22136.4966%22%3E2%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2249%22%20x%3D%22110%22%20y%3D%22136.4966%22%3EnewBuy%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22308%22%20x2%3D%22350%22%20y1%3D%22170.6953%22%20y2%3D%22170.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22350%22%20x2%3D%22350%22%20y1%3D%22170.6953%22%20y2%3D%22183.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22309%22%20x2%3D%22350%22%20y1%3D%22183.6953%22%20y2%3D%22183.6953%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22319%2C179.6953%2C309%2C183.6953%2C319%2C187.6953%2C315%2C183.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22315%22%20y%3D%22165.6294%22%3E3%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22328%22%20y%3D%22165.6294%22%3E%26%2339044%3B%26%2329983%3B%26%2325104%3B%26%2335746%3B%26%2321333%3B%26%2321495%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22308%22%20x2%3D%22350%22%20y1%3D%22212.8281%22%20y2%3D%22212.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22350%22%20x2%3D%22350%22%20y1%3D%22212.8281%22%20y2%3D%22225.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22309%22%20x2%3D%22350%22%20y1%3D%22225.8281%22%20y2%3D%22225.8281%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22319%2C221.8281%2C309%2C225.8281%2C319%2C229.8281%2C315%2C225.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22315%22%20y%3D%22207.7622%22%3E4%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22328%22%20y%3D%22207.7622%22%3E%26%2332452%3B%26%2335013%3B%26%2319979%3B%26%2321333%3B%26%2321442%3B%26%2325968%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22453%2C250.9609%2C463%2C254.9609%2C453%2C258.9609%2C457%2C254.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22308%22%20x2%3D%22459%22%20y1%3D%22254.9609%22%20y2%3D%22254.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22315%22%20y%3D%22249.895%22%3E5%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2279%22%20x%3D%22328%22%20y%3D%22249.895%22%3E%26%2321457%3B%26%2336865%3B%20half%26%2328040%3B%26%2324687%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22555.5%2C280.0938%2C565.5%2C284.0938%2C555.5%2C288.0938%2C559.5%2C284.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22308%22%20x2%3D%22561.5%22%20y1%3D%22284.0938%22%20y2%3D%22284.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22315%22%20y%3D%22279.0278%22%3E6%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22126%22%20x%3D%22328%22%20y%3D%22279.0278%22%3EpreInventoryDeduct%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22730.5%2C309.2266%2C740.5%2C313.2266%2C730.5%2C317.2266%2C734.5%2C313.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22567.5%22%20x2%3D%22736.5%22%20y1%3D%22313.2266%22%20y2%3D%22313.2266%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22574.5%22%20y%3D%22308.1606%22%3E7%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22103%22%20x%3D%22587.5%22%20y%3D%22308.1606%22%3ERedis%20%26%2324211%3B%26%2323384%3B%26%2339044%3B%26%2325187%3B%26%2320943%3B%3C%2Ftext%3E%3Cpath%20d%3D%22M707%2C326.2266%20L707%2C351.2266%20L777%2C351.2266%20L777%2C336.2266%20L767%2C326.2266%20L707%2C326.2266%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M767%2C326.2266%20L767%2C336.2266%20L777%2C336.2266%20L767%2C326.2266%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2249%22%20x%3D%22713%22%20y%3D%22343.2935%22%3Elua%20%26%2333050%3B%26%2326412%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22742.5%22%20x2%3D%22784.5%22%20y1%3D%22377.4922%22%20y2%3D%22377.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22784.5%22%20x2%3D%22784.5%22%20y1%3D%22377.4922%22%20y2%3D%22390.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22743.5%22%20x2%3D%22784.5%22%20y1%3D%22390.4922%22%20y2%3D%22390.4922%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22753.5%2C386.4922%2C743.5%2C390.4922%2C753.5%2C394.4922%2C749.5%2C390.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22749.5%22%20y%3D%22372.4263%22%3E8%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%22762.5%22%20y%3D%22372.4263%22%3E%26%2325187%3B%26%2320943%3B%26%2324211%3B%26%2323384%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22742.5%22%20x2%3D%22784.5%22%20y1%3D%22419.625%22%20y2%3D%22419.625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22784.5%22%20x2%3D%22784.5%22%20y1%3D%22419.625%22%20y2%3D%22432.625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22743.5%22%20x2%3D%22784.5%22%20y1%3D%22432.625%22%20y2%3D%22432.625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22753.5%2C428.625%2C743.5%2C432.625%2C753.5%2C436.625%2C749.5%2C432.625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%229%22%20x%3D%22749.5%22%20y%3D%22414.5591%22%3E9%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22762.5%22%20y%3D%22414.5591%22%3E%26%2326032%3B%26%2322686%3B%26%2325187%3B%26%2320943%3B%26%2327969%3B%26%2327700%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22578.5%2C457.7578%2C568.5%2C461.7578%2C578.5%2C465.7578%2C574.5%2C461.7578%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22572.5%22%20x2%3D%22741.5%22%20y1%3D%22461.7578%22%20y2%3D%22461.7578%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22584.5%22%20y%3D%22456.6919%22%3E10%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22129%22%20x%3D%22606.5%22%20y%3D%22456.6919%22%3ERedis%20%26%2324211%3B%26%2323384%3B%26%2339044%3B%26%2325187%3B%26%2320943%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22319%2C486.8906%2C309%2C490.8906%2C319%2C494.8906%2C315%2C490.8906%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22313%22%20x2%3D%22566.5%22%20y1%3D%22490.8906%22%20y2%3D%22490.8906%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22325%22%20y%3D%22485.8247%22%3E11%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2265%22%20x%3D%22347%22%20y%3D%22485.8247%22%3E%26%2339044%3B%26%2325187%3B%26%2320943%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22453%2C516.0234%2C463%2C520.0234%2C453%2C524.0234%2C457%2C520.0234%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22308%22%20x2%3D%22459%22%20y1%3D%22520.0234%22%20y2%3D%22520.0234%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22315%22%20y%3D%22514.9575%22%3E12%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22111%22%20x%3D%22337%22%20y%3D%22514.9575%22%3E%26%2323558%3Bhalf%26%2328040%3B%26%2324687%3Bcommit%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22101%2C545.1563%2C91%2C549.1563%2C101%2C553.1563%2C97%2C549.1563%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2295%22%20x2%3D%22307%22%20y1%3D%22549.1563%22%20y2%3D%22549.1563%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22107%22%20y%3D%22544.0903%22%3E13%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2239%22%20x%3D%22129%22%20y%3D%22544.0903%22%3E%26%2335746%3B%26%2321333%3B%26%2321495%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2290%22%20x2%3D%22132%22%20y1%3D%22578.2891%22%20y2%3D%22578.2891%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22132%22%20x2%3D%22132%22%20y1%3D%22578.2891%22%20y2%3D%22591.2891%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2291%22%20x2%3D%22132%22%20y1%3D%22591.2891%22%20y2%3D%22591.2891%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22101%2C587.2891%2C91%2C591.2891%2C101%2C595.2891%2C97%2C591.2891%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%2297%22%20y%3D%22573.2231%22%3E14%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22182%22%20x%3D%22119%22%20y%3D%22573.2231%22%3E%26%2328210%3B%26%2326579%3B%26%2325903%3B%26%2320184%3B%26%2320108%3B%26%2332500%3B%26%2330721%3B%26%2365292%3B%26%2324320%3B%26%2322987%3B%26%2325903%3B%26%2320184%3B%26%2327969%3B%26%2331243%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22835.5%2C616.4219%2C845.5%2C620.4219%2C835.5%2C624.4219%2C839.5%2C620.4219%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22465%22%20x2%3D%22841.5%22%20y1%3D%22620.4219%22%20y2%3D%22620.4219%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22472%22%20y%3D%22615.356%22%3E15%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22109%22%20x%3D%22494%22%20y%3D%22615.356%22%3E%26%2330417%3B%26%2321548%3B%20newBuy%20%26%2328040%3B%26%2324687%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22847.5%22%20x2%3D%22889.5%22%20y1%3D%22649.5547%22%20y2%3D%22649.5547%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22889.5%22%20x2%3D%22889.5%22%20y1%3D%22649.5547%22%20y2%3D%22662.5547%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22848.5%22%20x2%3D%22889.5%22%20y1%3D%22662.5547%22%20y2%3D%22662.5547%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22858.5%2C658.5547%2C848.5%2C662.5547%2C858.5%2C666.5547%2C854.5%2C662.5547%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22854.5%22%20y%3D%22644.4888%22%3E16%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22116%22%20x%3D%22876.5%22%20y%3D%22644.4888%22%3EcreateAndConfirm%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22847.5%22%20x2%3D%22889.5%22%20y1%3D%22691.6875%22%20y2%3D%22691.6875%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22889.5%22%20x2%3D%22889.5%22%20y1%3D%22691.6875%22%20y2%3D%22704.6875%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22848.5%22%20x2%3D%22889.5%22%20y1%3D%22704.6875%22%20y2%3D%22704.6875%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22858.5%2C700.6875%2C848.5%2C704.6875%2C858.5%2C708.6875%2C854.5%2C704.6875%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22854.5%22%20y%3D%22686.6216%22%3E17%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%22876.5%22%20y%3D%22686.6216%22%3E%26%2321069%3B%26%2332622%3B%26%2326657%3B%26%2339564%3B%3C%2Ftext%3E%3Cpath%20d%3D%22M940%2C679.0547%20L940%2C704.0547%20L1026%2C704.0547%20L1026%2C689.0547%20L1016%2C679.0547%20L940%2C679.0547%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M1016%2C679.0547%20L1016%2C689.0547%20L1026%2C689.0547%20L1016%2C679.0547%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2265%22%20x%3D%22946%22%20y%3D%22696.1216%22%3E%26%2336131%3B%26%2320219%3B%26%2338142%3B%26%2327169%3B%26%2324335%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22578.5%2C729.8203%2C568.5%2C733.8203%2C578.5%2C737.8203%2C574.5%2C733.8203%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22572.5%22%20x2%3D%22846.5%22%20y1%3D%22733.8203%22%20y2%3D%22733.8203%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22584.5%22%20y%3D%22728.7544%22%3E18%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22119%22%20x%3D%22606.5%22%20y%3D%22728.7544%22%3EtrySaleWithoutHint%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22567.5%22%20x2%3D%22609.5%22%20y1%3D%22762.9531%22%20y2%3D%22762.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22609.5%22%20x2%3D%22609.5%22%20y1%3D%22762.9531%22%20y2%3D%22775.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22568.5%22%20x2%3D%22609.5%22%20y1%3D%22775.9531%22%20y2%3D%22775.9531%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22578.5%2C771.9531%2C568.5%2C775.9531%2C578.5%2C779.9531%2C574.5%2C775.9531%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22574.5%22%20y%3D%22757.8872%22%3E19%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2265%22%20x%3D%22596.5%22%20y%3D%22757.8872%22%3E%26%2324211%3B%26%2323384%3B%26%2339044%3B%26%2325187%3B%26%2320943%3B%3C%2Ftext%3E%3Cpath%20d%3D%22M673%2C750.3203%20L673%2C775.3203%20L917%2C775.3203%20L917%2C760.3203%20L907%2C750.3203%20L673%2C750.3203%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M907%2C750.3203%20L907%2C760.3203%20L917%2C760.3203%20L907%2C750.3203%20%22%20fill%3D%22%23FEFFDD%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22223%22%20x%3D%22679%22%20y%3D%22767.3872%22%3E%26%2323545%3Bsaleable_inventory%20%26%2325187%3B%26%2320943%3B(%26%2326080%3B%20Hint%26%2365289%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22567.5%22%20x2%3D%22609.5%22%20y1%3D%22805.0859%22%20y2%3D%22805.0859%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22609.5%22%20x2%3D%22609.5%22%20y1%3D%22805.0859%22%20y2%3D%22818.0859%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22568.5%22%20x2%3D%22609.5%22%20y1%3D%22818.0859%22%20y2%3D%22818.0859%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22578.5%2C814.0859%2C568.5%2C818.0859%2C578.5%2C822.0859%2C574.5%2C818.0859%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22574.5%22%20y%3D%22800.02%22%3E20%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22104%22%20x%3D%22596.5%22%20y%3D%22800.02%22%3E%26%2326032%3B%26%2322686%3B%26%2324211%3B%26%2323384%3B%26%2325187%3B%26%2320943%3B%26%2327969%3B%26%2327700%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22835.5%2C843.2188%2C845.5%2C847.2188%2C835.5%2C851.2188%2C839.5%2C847.2188%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22567.5%22%20x2%3D%22841.5%22%20y1%3D%22847.2188%22%20y2%3D%22847.2188%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22574.5%22%20y%3D%22842.1528%22%3E21%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22130%22%20x%3D%22596.5%22%20y%3D%22842.1528%22%3E%26%2324211%3B%26%2323384%3B%26%2325968%3B%26%2325454%3B%26%2324211%3B%26%2339044%3B%26%2325187%3B%26%2320943%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22847.5%22%20x2%3D%22889.5%22%20y1%3D%22876.3516%22%20y2%3D%22876.3516%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22889.5%22%20x2%3D%22889.5%22%20y1%3D%22876.3516%22%20y2%3D%22889.3516%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22848.5%22%20x2%3D%22889.5%22%20y1%3D%22889.3516%22%20y2%3D%22889.3516%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22858.5%2C885.3516%2C848.5%2C889.3516%2C858.5%2C893.3516%2C854.5%2C889.3516%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22854.5%22%20y%3D%22871.2856%22%3E22%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22136%22%20x%3D%22876.5%22%20y%3D%22871.2856%22%3E%26%2321019%3B%26%2324314%3B%26%2335746%3B%26%2321333%3B%26%2365288%3BCONFIRM%26%2365289%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22319%2C914.4844%2C309%2C918.4844%2C319%2C922.4844%2C315%2C918.4844%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22313%22%20x2%3D%22846.5%22%20y1%3D%22918.4844%22%20y2%3D%22918.4844%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22325%22%20y%3D%22913.4185%22%3E23%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%22347%22%20y%3D%22913.4185%22%3E%26%2319979%3B%26%2321333%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22101%2C943.6172%2C91%2C947.6172%2C101%2C951.6172%2C97%2C947.6172%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2295%22%20x2%3D%22307%22%20y1%3D%22947.6172%22%20y2%3D%22947.6172%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%22107%22%20y%3D%22942.5513%22%3E24%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2239%22%20x%3D%22129%22%20y%3D%22942.5513%22%3E%26%2335746%3B%26%2321333%3B%26%2321495%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2290%22%20x2%3D%22132%22%20y1%3D%22976.75%22%20y2%3D%22976.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22132%22%20x2%3D%22132%22%20y1%3D%22976.75%22%20y2%3D%22989.75%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2291%22%20x2%3D%22132%22%20y1%3D%22989.75%22%20y2%3D%22989.75%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22101%2C985.75%2C91%2C989.75%2C101%2C993.75%2C97%2C989.75%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2218%22%20x%3D%2297%22%20y%3D%22971.6841%22%3E25%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22182%22%20x%3D%22119%22%20y%3D%22971.6841%22%3E%26%2328210%3B%26%2326579%3B%26%2325903%3B%26%2320184%3B%26%2320108%3B%26%2332500%3B%26%2330721%3B%26%2365292%3B%26%2324320%3B%26%2322987%3B%26%2325903%3B%26%2320184%3B%26%2327969%3B%26%2331243%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E)

















### 支付













![img](https://cdn.nlark.com/yuque/__puml/65a33991ed7e9dba052d3917a48f2f97.svg)











这里的订单不仅要做自己的状态突进，还需要做单笔订单只能支付成功一次的管控，避免用户出现多付，如果出现多付，则需要进行退款。











在支付成功后，订单状态则推进到 PAID

















### 取消订单













![img](https://cdn.nlark.com/yuque/__puml/4d085d7d6b7156b8e53770c8fb617e1e.svg)











这里我们为了保证取消订单和库存回退的数据一致性，利用了 RocketMQ 的事务消息。











当订单取消后，状态变成 CLOSED，closeType为CANCEL。











### 超时关单











订单的关闭，除了用户主动取消外，还会有超时关单的情况。超时关单的逻辑和用户主动取消的逻辑其实是一样的，只不过入口不一样。











超时关单主要是由定时任务触发的，也有的是用户主动访问订单的时候也可能会触发已超时的订单的关单。但是不管怎么样，后续处理逻辑一样。











当订单超时后，状态变成 CLOSED，closeType为TIME_OUT。





# ✅订单为什么没有 PAYING 状态？





![img](https://tcs-devops.aliyuncs.com/storage/11391738f4b969d3b4f523c37b16f103c4c0?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTczMDQ0MTcwMywiaWF0IjoxNzI5ODM2OTAzLCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExMzkxNzM4ZjRiOTY5ZDNiNGY1MjNjMzdiMTZmMTAzYzRjMCJ9.R05G7c6VYGIs1CpkTVxe7fRZB12i4i8ki3UEr7KoIKg)











这是我们的订单的状态机，为什么没有PAYING 状态表示支付中呢？











其实没有任何必要，反而会带来很多问题：











因为订单的支付可能发起多次，因为用户可能会不同的渠道支付，也可能取消支付在发起一次，那么这个状态就需要不断变化，从 CONFIRM 到 PAYING，在回退到 CONFIRM，就很麻烦。











而且，这个 PAYING 也没啥用，如果想知道订单是否在支付中，用订单号去支付单表查询是否有在途的支付单就行了，在订单上冗余这个状态没必要，而且还要想办法保证一致性，即如果支付单超时了，那么订单状态也好的跟着修改，太麻烦。











而 CONFIRM 之后，直接到PAID，表示订单支付成功即可，这才是一个明确的状态，中间的支付中状态没有带来什么额外的好处，也没有解决什么实际的问题，反而带来了缺点。











### 交易完成











订单还有最后一个操作，那就是当交易成功后，持有藏品完成创建，并且上链成功后，则推进到交易完成状态。



















![img](https://cdn.nlark.com/yuque/__puml/bd72f161653041bcf3dc4dab550ce46b.svg)

















这一阶段执行完之后，订单状态为 FINISH。





# 超时关单设计



在订单的超时关单的设计中，我们为了提升扫表性能，做了一下几个事情：











1、主动关单









##### ✅基于主动+被动组合方式实现订单的关闭

订单创建成功之后，超过一定时间不支付，就需要关闭订单，这里方案有很多，比如用 MQ、定时任务、Redis 等等。 我们选择了一种相对轻量并且也比较可靠的方案，那就是 XXL-JOB 定时任务，并且为了减少 XXL-JOB 关单的延迟问题，我

NFTurbo文档









2、XXL-JOB 分片任务->没有用 MQ









##### ✅基于XXL-JOB的分片实现分库分表后的扫表

在我们的项目中，需要通过定时任务来扫描订单表，进行超时未支付的订单的关单操作。 但是因为我们的表是做了分库分表的，并且数据量会很大，单机任务扫表的性能可能不能满足要求，会比较慢，导致任务堆积。 为了解决这个问题，我们采用多线程扫表的方案，这

NFTurbo文档













##### ✅为什么不用MQ实现支付单的到期关闭？

实现支付单/订单的到期关闭有很多种方案，大的层面是分来两种，一种是基于延迟消息，一种是基于定时任务。  我们的项目中用了 RocketMQ 作为消息队列，为啥不直接使用他的延迟消息实现订单的到期关闭呢？ 其实这个方案主要是参考了阿里内部的超

NFTurbo文档



3、生产者消费者模式-BlockingQueue











`BlockingQueue`其实就是阻塞队列，是基于阻塞机制实现的线程安全的队列。











`BlockingQueue`的特点是当队列满时，会阻塞入队的线程，直到队列不满；当队列为空时，会阻塞出队的线程，直到队列中有元素。











`BlockingQueue`常用于**生产者-消费者模型**中，往队列里添加元素的是生产者，从队列中获取元素的是消费者；通常情况下生产者和消费者都是由多个线程组成；下图所示则为一个最常见的**生产者-消费者模型**，生产者和消费者之间通过队列平衡两者的的处理能力、进行解耦等。











4、线程池-ForkJoinPool











5、毒丸对象
# ✅支付模块设计



支付模块，承担了我们的项目中的和支付相关的功能，是我们项目中非常重要的模块。

![img](https://tcs-devops.aliyuncs.com/storage/113ab6367be9f5e157a879c8dbe624877642?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTczMDQ0MjY2NCwiaWF0IjoxNzI5ODM3ODY0LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExM2FiNjM2N2JlOWY1ZTE1N2E4NzljOGRiZTYyNDg3NzY0MiJ9.P-fAIPY-n6Hk69gH-UbosYujGU7pAsM195UUGL8LpFE)



## 模型设计

![img](https://cdn.nlark.com/yuque/0/2024/jpeg/5378072/1726641867911-e07182f6-2f99-46f7-ad36-6d358d66b1a0.jpeg)



为了让支付更加具有通用性，我们在支付单这张表中没有任何和订单有关的信息，我们的付款方没有叫buyer_id，存订单号也没有用 order_id。而是定义了支付单领域自己的属性，如付款方、收款方、业务单号等等。目的就是更具有通用性，模型更加内聚。

同时，为了支持多付退款，我们还有一张退款单的表。

## 状态机

![img](https://tcs-devops.aliyuncs.com/storage/113aa4ba1a6cb847f1e10449e3a3795b3187?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTczMDQ0MjY2NCwiaWF0IjoxNzI5ODM3ODY0LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExM2FhNGJhMWE2Y2I4NDdmMWUxMDQ0OWUzYTM3OTViMzE4NyJ9.LG2fFKVbPahlKzftITfl4sPjA6oV6b3oBY3N8xe-6UU)



﻿



## 业务流程

### 下单支付

![img](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22910px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A1140px%3Bheight%3A910px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%201140%20910%22%20width%3D%221140px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2222%22%20x2%3D%2222%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22217.5%22%20x2%3D%22217.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22358.5%22%20x2%3D%22358.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22645.5%22%20x2%3D%22645.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22798.5%22%20x2%3D%22798.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22938.5%22%20x2%3D%22938.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%221068.5%22%20x2%3D%221068.5%22%20y1%3D%2281.2969%22%20y2%3D%22829.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2228%22%20x%3D%225%22%20y%3D%2277.9951%22%3E%26%2329992%3B%26%2325143%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2222%22%20cy%3D%2213.5%22%20fill%3D%22%23E2E2F0%22%20rx%3D%228%22%20ry%3D%228%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M22%2C21.5%20L22%2C48.5%20M9%2C29.5%20L35%2C29.5%20M22%2C48.5%20L9%2C63.5%20M22%2C48.5%20L35%2C63.5%20%22%20fill%3D%22none%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2228%22%20x%3D%225%22%20y%3D%22841.9482%22%3E%26%2329992%3B%26%2325143%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2222%22%20cy%3D%22853.75%22%20fill%3D%22%23E2E2F0%22%20rx%3D%228%22%20ry%3D%228%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Cpath%20d%3D%22M22%2C861.75%20L22%2C888.75%20M9%2C869.75%20L35%2C869.75%20M22%2C888.75%20L9%2C903.75%20M22%2C888.75%20L35%2C903.75%20%22%20fill%3D%22none%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22115%22%20x%3D%22160.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22101%22%20x%3D%22167.5%22%20y%3D%2269.9951%22%3Enft-turbo-trade%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22115%22%20x%3D%22160.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22101%22%20x%3D%22167.5%22%20y%3D%22848.9482%22%3Enft-turbo-trade%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%22307.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%22314.5%22%20y%3D%2269.9951%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%22307.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%22314.5%22%20y%3D%22848.9482%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22145%22%20x%3D%22573.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22131%22%20x%3D%22580.5%22%20y%3D%2269.9951%22%3Enft-turbo-collection%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22145%22%20x%3D%22573.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22131%22%20x%3D%22580.5%22%20y%3D%22848.9482%22%3Enft-turbo-collection%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22140%22%20x%3D%22728.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22126%22%20x%3D%22735.5%22%20y%3D%2269.9951%22%3Ewxpay%26%2365288%3B%26%2324494%3B%26%2320449%3B%26%2325903%3B%26%2320184%3B%26%2365289%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22140%22%20x%3D%22728.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22126%22%20x%3D%22735.5%22%20y%3D%22848.9482%22%3Ewxpay%26%2365288%3B%26%2324494%3B%26%2320449%3B%26%2325903%3B%26%2320184%3B%26%2365289%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22120%22%20x%3D%22878.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22106%22%20x%3D%22885.5%22%20y%3D%2269.9951%22%3Enft_turbo_order%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22120%22%20x%3D%22878.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22106%22%20x%3D%22885.5%22%20y%3D%22848.9482%22%3Enft_turbo_order%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22120%22%20x%3D%221008.5%22%20y%3D%2250%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22106%22%20x%3D%221015.5%22%20y%3D%2269.9951%22%3Enft_turbo_chain%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22120%22%20x%3D%221008.5%22%20y%3D%22828.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22106%22%20x%3D%221015.5%22%20y%3D%22848.9482%22%3Enft_turbo_chain%3C%2Ftext%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%223%22%20style%3D%22stroke%3A%23EEEEEE%3Bstroke-width%3A1.0%3B%22%20width%3D%221133.5%22%20x%3D%220%22%20y%3D%22111.8633%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22111.8633%22%20y2%3D%22111.8633%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22114.8633%22%20y2%3D%22114.8633%22%2F%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%2223.1328%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A2.0%3B%22%20width%3D%22103%22%20x%3D%22515.25%22%20y%3D%22101.2969%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2284%22%20x%3D%22521.25%22%20y%3D%22117.3638%22%3E%26%2329983%3B%26%2325104%3B%26%2325903%3B%26%2320184%3B%26%2338142%3B%26%2325509%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22347%2C151.5625%2C357%2C155.5625%2C347%2C159.5625%2C351%2C155.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22218%22%20x2%3D%22353%22%20y1%3D%22155.5625%22%20y2%3D%22155.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22225%22%20y%3D%22150.4966%22%3E%26%2329983%3B%26%2325104%3B%26%2325903%3B%26%2320184%3B%26%2338142%3B%26%2325509%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22184.6953%22%20y2%3D%22184.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22184.6953%22%20y2%3D%22197.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22197.6953%22%20y2%3D%22197.6953%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C193.6953%2C360%2C197.6953%2C370%2C201.6953%2C366%2C197.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22139%22%20x%3D%22366%22%20y%3D%22179.6294%22%3E%26%2321019%3B%26%2324314%3B%26%2325903%3B%26%2320184%3B%26%2321333%3B%26%2365288%3BTO_PAY%26%2365289%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22226.8281%22%20y2%3D%22226.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22226.8281%22%20y2%3D%22239.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22239.8281%22%20y2%3D%22239.8281%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C235.8281%2C360%2C239.8281%2C370%2C243.8281%2C366%2C239.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22260%22%20x%3D%22366%22%20y%3D%22221.7622%22%3E%26%2336890%3B%26%2336807%3B%26%2324037%3B%26%2321378%3B%26%2333719%3B%26%2321462%3B%26%2326412%3B%26%2327425%3B%26%2335843%3B%26%2329992%3B%26%2330340%3B%26%2325903%3B%26%2320184%3B%26%2326041%3B%26%2324335%3B%26%2326159%3B%26%2324494%3B%26%2320449%3B%26%2325903%3B%26%2320184%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22786.5%2C264.9609%2C796.5%2C268.9609%2C786.5%2C272.9609%2C790.5%2C268.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22792.5%22%20y1%3D%22268.9609%22%20y2%3D%22268.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22289%22%20x%3D%22366%22%20y%3D%22263.895%22%3E%26%2336890%3B%26%2336807%3BIJPay%26%2330340%3B%26%2320108%3B%26%2326041%3B%26%2321253%3B%26%2335843%3B%26%2329992%3B%26%2324494%3B%26%2320449%3B%26%2325903%3B%26%2320184%3B%26%2336827%3B%26%2334892%3B%26%2325903%3B%26%2320184%3B%26%2338142%3B%26%2325509%3B%26%2329983%3B%26%2325104%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C294.0938%2C360%2C298.0938%2C370%2C302.0938%2C366%2C298.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22364%22%20x2%3D%22797.5%22%20y1%3D%22298.0938%22%20y2%3D%22298.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22403%22%20x%3D%22376%22%20y%3D%22293.0278%22%3E%26%2321516%3B%26%2327493%3B%26%2336820%3B%26%2322238%3B%26%2329983%3B%26%2325104%3B%26%2332467%3B%26%2326524%3B%26%2365292%3B%26%2324182%3B%26%2326681%3B%26%2325454%3B%26%2335777%3B%26%2320070%3B%26%2324207%3B%26%2321015%3B%26%2321495%3B%26%2326597%3B%26%2335810%3B%26%2323545%3B%26%2324212%3B%26%2330340%3B%26%2335777%3B%26%2320070%3B%26%2326469%3B%26%2339564%3B%26%2335777%3B%26%2331614%3B%26%2321517%3B%26%2332467%3B%26%2326524%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22327.2266%22%20y2%3D%22327.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22327.2266%22%20y2%3D%22340.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22340.2266%22%20y2%3D%22340.2266%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C336.2266%2C360%2C340.2266%2C370%2C344.2266%2C366%2C340.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22164%22%20x%3D%22366%22%20y%3D%22322.1606%22%3E%26%2326356%3B%26%2326032%3B%26%2325903%3B%26%2320184%3B%26%2321333%3B%26%2329366%3B%26%2324577%3B%26%2365288%3BPAYING%26%2365289%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22369.3594%22%20y2%3D%22369.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22369.3594%22%20y2%3D%22382.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22382.3594%22%20y2%3D%22382.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C378.3594%2C360%2C382.3594%2C370%2C386.3594%2C366%2C382.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22141%22%20x%3D%22366%22%20y%3D%22364.2935%22%3E%26%2326356%3B%26%2326032%3B%26%2325903%3B%26%2320184%3B%26%2321333%3B%26%2319978%3B%26%2330340%3B%20pay_url%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22229%2C407.4922%2C219%2C411.4922%2C229%2C415.4922%2C225%2C411.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22223%22%20x2%3D%22358%22%20y1%3D%22411.4922%22%20y2%3D%22411.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22117%22%20x%3D%22235%22%20y%3D%22406.4263%22%3E%26%2336820%3B%26%2322238%3B%26%2325903%3B%26%2320184%3B%26%2338142%3B%26%2325509%3B%26%2332473%3B%26%2329992%3B%26%2325143%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%223%22%20style%3D%22stroke%3A%23EEEEEE%3Bstroke-width%3A1.0%3B%22%20width%3D%221133.5%22%20x%3D%220%22%20y%3D%22440.0586%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22440.0586%22%20y2%3D%22440.0586%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22443.0586%22%20y2%3D%22443.0586%22%2F%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%2223.1328%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A2.0%3B%22%20width%3D%2275%22%20x%3D%22529.25%22%20y%3D%22429.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22535.25%22%20y%3D%22445.5591%22%3E%26%2329992%3B%26%2325143%3B%26%2325195%3B%26%2330721%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2233%2C479.7578%2C23%2C483.7578%2C33%2C487.7578%2C29%2C483.7578%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2227%22%20x2%3D%22217%22%20y1%3D%22483.7578%22%20y2%3D%22483.7578%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22156%22%20x%3D%2239%22%20y%3D%22478.6919%22%3E%26%2336820%3B%26%2322238%3B%26%2325903%3B%26%2320184%3B%26%2338142%3B%26%2325509%3B%26%2336716%3B%26%2321270%3B%26%2325104%3B%26%2320108%3B%26%2332500%3B%26%2330721%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2222%22%20x2%3D%2264%22%20y1%3D%22512.8906%22%20y2%3D%22512.8906%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2264%22%20x2%3D%2264%22%20y1%3D%22512.8906%22%20y2%3D%22525.8906%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2223%22%20x2%3D%2264%22%20y1%3D%22525.8906%22%20y2%3D%22525.8906%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2233%2C521.8906%2C23%2C525.8906%2C33%2C529.8906%2C29%2C525.8906%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22182%22%20x%3D%2229%22%20y%3D%22507.8247%22%3E%26%2329992%3B%26%2325143%3B%26%2336890%3B%26%2336807%3B%26%2324494%3B%26%2320449%3B%26%2336827%3B%26%2334892%3B%26%2325195%3B%26%2330721%3B%26%2365292%3B%26%2324182%3B%26%2325903%3B%26%2320184%3B%3C%2Ftext%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%223%22%20style%3D%22stroke%3A%23EEEEEE%3Bstroke-width%3A1.0%3B%22%20width%3D%221133.5%22%20x%3D%220%22%20y%3D%22554.457%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22554.457%22%20y2%3D%22554.457%22%2F%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3B%22%20x1%3D%220%22%20x2%3D%221133.5%22%20y1%3D%22557.457%22%20y2%3D%22557.457%22%2F%3E%3Crect%20fill%3D%22%23EEEEEE%22%20height%3D%2223.1328%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A2.0%3B%22%20width%3D%2275%22%20x%3D%22529.25%22%20y%3D%22543.8906%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22535.25%22%20y%3D%22559.9575%22%3E%26%2325903%3B%26%2320184%3B%26%2322238%3B%26%2335843%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C594.1563%2C360%2C598.1563%2C370%2C602.1563%2C366%2C598.1563%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22364%22%20x2%3D%22797.5%22%20y1%3D%22598.1563%22%20y2%3D%22598.1563%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22221%22%20x%3D%22376%22%20y%3D%22593.0903%22%3E%26%2329992%3B%26%2325143%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%26%2365292%3B%26%2324494%3B%26%2320449%3B%26%2325903%3B%26%2320184%3B%26%2335843%3B%26%2329992%3B%26%2322238%3B%26%2335843%3B%26%2322320%3B%26%2322336%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22627.2891%22%20y2%3D%22627.2891%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22627.2891%22%20y2%3D%22640.2891%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22640.2891%22%20y2%3D%22640.2891%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C636.2891%2C360%2C640.2891%2C370%2C644.2891%2C366%2C640.2891%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22366%22%20y%3D%22622.2231%22%3E%26%2333719%3B%26%2321462%3B%26%2325903%3B%26%2320184%3B%26%2323494%3B%26%2325991%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22669.4219%22%20y2%3D%22669.4219%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22669.4219%22%20y2%3D%22682.4219%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22682.4219%22%20y2%3D%22682.4219%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C678.4219%2C360%2C682.4219%2C370%2C686.4219%2C366%2C682.4219%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22273%22%20x%3D%22366%22%20y%3D%22664.356%22%3E%26%2336890%3B%26%2336807%3B%26%2335777%3B%26%2320070%3B%26%2324207%3B%26%2321015%3B%26%2321495%3B%26%2326597%3B%26%2325214%3B%26%2323545%3B%26%2324212%3B%26%2330340%3B%26%2335777%3B%26%2320070%3B%26%2365292%3B%26%2324182%3B%26%2335299%3B%26%2326512%3B%26%2325104%3B%26%2326126%3B%26%2325991%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22401%22%20y1%3D%22711.5547%22%20y2%3D%22711.5547%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22401%22%20x2%3D%22401%22%20y1%3D%22711.5547%22%20y2%3D%22724.5547%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22360%22%20x2%3D%22401%22%20y1%3D%22724.5547%22%20y2%3D%22724.5547%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22370%2C720.5547%2C360%2C724.5547%2C370%2C728.5547%2C366%2C724.5547%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22196%22%20x%3D%22366%22%20y%3D%22706.4888%22%3E%26%2333719%3B%26%2321462%3B%26%2325903%3B%26%2320184%3B%26%2332467%3B%26%2326524%3B%26%2365292%3B%26%2326356%3B%26%2326032%3B%26%2325903%3B%26%2320184%3B%26%2321333%3B(PAID)%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22926.5%2C749.6875%2C936.5%2C753.6875%2C926.5%2C757.6875%2C930.5%2C753.6875%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22932.5%22%20y1%3D%22753.6875%22%20y2%3D%22753.6875%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22366%22%20y%3D%22748.6216%22%3E%26%2326356%3B%26%2326032%3B%26%2335746%3B%26%2321333%3B%26%2329366%3B%26%2324577%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22634%2C778.8203%2C644%2C782.8203%2C634%2C786.8203%2C638%2C782.8203%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%22640%22%20y1%3D%22782.8203%22%20y2%3D%22782.8203%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22143%22%20x%3D%22366%22%20y%3D%22777.7544%22%3E%26%2325187%3B%26%2320943%3B%26%2324211%3B%26%2323384%3B%26%2312289%3B%26%2329983%3B%26%2325104%3B%26%2325345%3B%26%2326377%3B%26%2334255%3B%26%2321697%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%221056.5%2C807.9531%2C1066.5%2C811.9531%2C1056.5%2C815.9531%2C1060.5%2C811.9531%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22359%22%20x2%3D%221062.5%22%20y1%3D%22811.9531%22%20y2%3D%22811.9531%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2226%22%20x%3D%22366%22%20y%3D%22806.8872%22%3E%26%2319978%3B%26%2338142%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E)



关于支付成功后的具体操作，详见：

##### ✅基于Seata分布式事务实现支付环节的数据一致性

在订单完成支付后，我们会接受到外部支付渠道的支付成功消息。接收到消息之后需要做以下事情： 三种情况，支付成功、重复支付、以及支付幂等。其中支付成功这个子流程，可以看到我们操作了很多模块，包括了订单、支付、藏品、链等等。 那么，我们如何保证

### 多付退款



﻿



在支付环节，是有一种特殊情况，那就是多付的情况，就是一笔订单，重复支付了。



﻿



﻿

![img](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22381px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A296px%3Bheight%3A381px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20296%20381%22%20width%3D%22296px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22none%22%20height%3D%22204.2734%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22279%22%20x%3D%2210%22%20y%3D%22124.5625%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22116.2031%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22259%22%20x%3D%2220%22%20y%3D%22148.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2281%22%20x2%3D%2281%22%20y1%3D%2236.2969%22%20y2%3D%22345.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22212.5%22%20x2%3D%22212.5%22%20y1%3D%2236.2969%22%20y2%3D%22345.8359%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%2230%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%2237%22%20y%3D%2224.9951%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%2230%22%20y%3D%22344.8359%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%2237%22%20y%3D%22364.8311%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%22184.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%22191.5%22%20y%3D%2224.9951%22%3Ewxpay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%22184.5%22%20y%3D%22344.8359%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%22191.5%22%20y%3D%22364.8311%22%3Ewxpay%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C63.4297%2C82.5%2C67.4297%2C92.5%2C71.4297%2C88.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2286.5%22%20x2%3D%22211.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2298.5%22%20y%3D%2262.3638%22%3E%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C105.5625%2C82.5%2C109.5625%2C92.5%2C113.5625%2C88.5%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%2291.4966%22%3E%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cpath%20d%3D%22M10%2C124.5625%20L74%2C124.5625%20L74%2C131.6953%20L64%2C141.6953%20L10%2C141.6953%20L10%2C124.5625%20%22%20fill%3D%22%23EEEEEE%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22204.2734%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22279%22%20x%3D%2210%22%20y%3D%22124.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2219%22%20x%3D%2225%22%20y%3D%22137.6294%22%3Ealt%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%2289%22%20y%3D%22136.7729%22%3E%5B%26%2335746%3B%26%2321333%3B%26%2324050%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%5D%3C%2Ftext%3E%3Cpath%20d%3D%22M20%2C148.6953%20L84%2C148.6953%20L84%2C155.8281%20L74%2C165.8281%20L20%2C165.8281%20L20%2C148.6953%20%22%20fill%3D%22%23EEEEEE%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22116.2031%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22259%22%20x%3D%2220%22%20y%3D%22148.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2219%22%20x%3D%2235%22%20y%3D%22161.7622%22%3Ealt%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22175%22%20x%3D%2299%22%20y%3D%22160.9058%22%3E%5B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2328192%3B%26%2336947%3B%26%2321644%3B%26%2321333%3B%26%2321495%3B%26%2319982%3B%26%2326412%3B%26%2327425%3B%26%2325903%3B%26%2320184%3B%26%2330456%3B%26%2321516%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22186.9609%22%20y2%3D%22186.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22186.9609%22%20y2%3D%22199.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22199.9609%22%20y2%3D%22199.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C195.9609%2C82.5%2C199.9609%2C92.5%2C203.9609%2C88.5%2C199.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%22181.895%22%3E%26%2324130%3B%26%2331561%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2220%22%20x2%3D%22279%22%20y1%3D%22208.9609%22%20y2%3D%22208.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22186%22%20x%3D%2225%22%20y%3D%22219.1714%22%3E%5B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2328192%3B%26%2336947%3B%26%2321644%3B%26%2321333%3B%26%2321495%3B%26%2319982%3B%26%2326412%3B%26%2327425%3B%26%2325903%3B%26%2320184%3B%26%2319981%3B%26%2330456%3B%26%2321516%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22243.8984%22%20y2%3D%22243.8984%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22243.8984%22%20y2%3D%22256.8984%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22256.8984%22%20y2%3D%22256.8984%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C252.8984%2C82.5%2C256.8984%2C92.5%2C260.8984%2C88.5%2C256.8984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%22238.8325%22%3E%26%2322810%3B%26%2320184%3B%26%2336864%3B%26%2327454%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2210%22%20x2%3D%22289%22%20y1%3D%22272.8984%22%20y2%3D%22272.8984%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%2215%22%20y%3D%22283.1089%22%3E%5B%26%2335746%3B%26%2321333%3B%26%2326410%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22307.8359%22%20y2%3D%22307.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22307.8359%22%20y2%3D%22320.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22320.8359%22%20y2%3D%22320.8359%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C316.8359%2C82.5%2C320.8359%2C92.5%2C324.8359%2C88.5%2C320.8359%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22117%22%20x%3D%2288.5%22%20y%3D%22302.77%22%3E%26%2325191%3B%26%2334892%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2336923%3B%26%2336753%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E)



﻿



在支付成功的处理中，我们会检查订单的状态，如果支付单对应的订单未支付成功，说明当前是第一次支付成功，则执行上面的支付成功逻辑即可。



﻿



如果支付单对应的订单已经支付成功了，那么就有2种可能：



1、同一个支付成功回调，支付渠道消息重投了。



2、不同的支付成功回调，用户多付了。



﻿



如果是第一种情况，那么直接幂等掉，返回成功即可，如果是第二种情况，那么则需要进行退款了。



﻿



具体的关于为什么会重复支付、如何解决，详见：



﻿



﻿✅重复支付问题如何解决？



### **为什么会重复支付？**











大家看了支付这部分的代码应该会知道，在生成支付链接的时候，我们是做了幂等控制的，严格的遵守了"一锁、二判、三更新"的。













![img](https://tcs-devops.aliyuncs.com/storage/113a63be7f8f8b2d6975dda833dd675462ff?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTczMDQ0MTMxMiwiaWF0IjoxNzI5ODM2NTEyLCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExM2E2M2JlN2Y4ZjhiMmQ2OTc1ZGRhODMzZGQ2NzU0NjJmZiJ9.hCoRT_qbzWS6q2EScjMx9eTvYII34Tshsg418hUiQIM)







![img](https://tcs-devops.aliyuncs.com/storage/113a92469c5380489aee0fa39623a872ac2c?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9hcHBJZCI6IjVlNzQ4MmQ2MjE1MjJiZDVjN2Y5YjMzNSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTczMDQ0MTMxMiwiaWF0IjoxNzI5ODM2NTEyLCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzExM2E5MjQ2OWM1MzgwNDg5YWVlMGZhMzk2MjNhODcyYWMyYyJ9.iqkLow9DWCfM4l2JkpkvZJ1me8K5eTCMsYyXHSapmxU)











这样确实可以保证幂等，但是，如果大家仔细看的话，会发现，我们在查询支付单的时候，条件如下：











```
PayOrder selectByBizNoAndPayer(String payerId, String bizNo, String bizType, String payChannel);



Plain Text
```











付款方、订单号（业务单号+业务类型）、支付渠道，是用这三个关键信息做的唯一性检查。那么也就说，如果用户针对同一笔订单，换了一个支付方式的话，比如之前用微信、现在改用支付宝，那么就可以重新发起一次新的支付了。











虽然我们加的分布式锁是针对bizNo 也就是订单号加的锁，但是分布式锁防的是并发，如果没有并发呢？看一下这个真实场景：











用户下单后，先用微信支付去付款，用微信支付扫码后，因为网络问题，一直转圈圈。用户以为支付失败了。他关闭微信的手机进程，重新回到订单这里，换用支付宝付款。付款成功。











但是，之前那笔微信支付的付款操作，是有可能实际支付成功的。那么一旦他成功了，就意味着同一笔订单，微信、支付宝都支付成功了，这就发生了重复支付的问题。而且这个问题没办法防止，你总不能要求用户微信支付发起后，就不能再发起支付宝支付了吧。万一用户微信钱不够，想换支付宝付款，这再正常不过了。











所以，我们需要通过技术手段来识别并解决这个问题。











### 如何识别多付？





那么，我们如何识别出一笔订单多付了呢？











1、订单需要有一个明确的状态，记录下来订单已经被支付成功过了。





2、订单上需要记录是哪笔支付单最终把他推进到支付成功的。具体的就是哪个渠道和那笔具体的支付交易。





3、支付成功回调接受到时，判断订单状态是否已支付。





3.1、如果订单状态为未支付成功，说明当前是第一次支付成功，则把订单推进到已支付成功，并记录当前的渠道和渠道流水号。





3.2、如果支付单对应的订单已经支付成功了，则判断当前订单上记录的渠道和渠道流水号和本次成功的渠道&流水号是否一致。





3.2.1、如果一致，说明是消息重投了，直接做幂等处理即可。





3.2.2、如果不一致，说明之前已经有一个渠道支付成功过了，那当前这笔支付就是多付了。则执行退款操作。



















![img](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22381px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A296px%3Bheight%3A381px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20296%20381%22%20width%3D%22296px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22none%22%20height%3D%22204.2734%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22279%22%20x%3D%2210%22%20y%3D%22124.5625%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22116.2031%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22259%22%20x%3D%2220%22%20y%3D%22148.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2281%22%20x2%3D%2281%22%20y1%3D%2236.2969%22%20y2%3D%22345.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22212.5%22%20x2%3D%22212.5%22%20y1%3D%2236.2969%22%20y2%3D%22345.8359%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%2230%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%2237%22%20y%3D%2224.9951%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22103%22%20x%3D%2230%22%20y%3D%22344.8359%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2289%22%20x%3D%2237%22%20y%3D%22364.8311%22%3Enft-turbo-pay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%22184.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%22191.5%22%20y%3D%2224.9951%22%3Ewxpay%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2256%22%20x%3D%22184.5%22%20y%3D%22344.8359%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2242%22%20x%3D%22191.5%22%20y%3D%22364.8311%22%3Ewxpay%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C63.4297%2C82.5%2C67.4297%2C92.5%2C71.4297%2C88.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2286.5%22%20x2%3D%22211.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2298.5%22%20y%3D%2262.3638%22%3E%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C105.5625%2C82.5%2C109.5625%2C92.5%2C113.5625%2C88.5%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%2291.4966%22%3E%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cpath%20d%3D%22M10%2C124.5625%20L74%2C124.5625%20L74%2C131.6953%20L64%2C141.6953%20L10%2C141.6953%20L10%2C124.5625%20%22%20fill%3D%22%23EEEEEE%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22204.2734%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22279%22%20x%3D%2210%22%20y%3D%22124.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2219%22%20x%3D%2225%22%20y%3D%22137.6294%22%3Ealt%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%2289%22%20y%3D%22136.7729%22%3E%5B%26%2335746%3B%26%2321333%3B%26%2324050%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%5D%3C%2Ftext%3E%3Cpath%20d%3D%22M20%2C148.6953%20L84%2C148.6953%20L84%2C155.8281%20L74%2C165.8281%20L20%2C165.8281%20L20%2C148.6953%20%22%20fill%3D%22%23EEEEEE%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%2F%3E%3Crect%20fill%3D%22none%22%20height%3D%22116.2031%22%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.5%3B%22%20width%3D%22259%22%20x%3D%2220%22%20y%3D%22148.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2219%22%20x%3D%2235%22%20y%3D%22161.7622%22%3Ealt%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22175%22%20x%3D%2299%22%20y%3D%22160.9058%22%3E%5B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2328192%3B%26%2336947%3B%26%2321644%3B%26%2321333%3B%26%2321495%3B%26%2319982%3B%26%2326412%3B%26%2327425%3B%26%2325903%3B%26%2320184%3B%26%2330456%3B%26%2321516%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22186.9609%22%20y2%3D%22186.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22186.9609%22%20y2%3D%22199.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22199.9609%22%20y2%3D%22199.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C195.9609%2C82.5%2C199.9609%2C92.5%2C203.9609%2C88.5%2C199.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%22181.895%22%3E%26%2324130%3B%26%2331561%3B%26%2325104%3B%26%2321151%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2220%22%20x2%3D%22279%22%20y1%3D%22208.9609%22%20y2%3D%22208.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22186%22%20x%3D%2225%22%20y%3D%22219.1714%22%3E%5B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2328192%3B%26%2336947%3B%26%2321644%3B%26%2321333%3B%26%2321495%3B%26%2319982%3B%26%2326412%3B%26%2327425%3B%26%2325903%3B%26%2320184%3B%26%2319981%3B%26%2330456%3B%26%2321516%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22243.8984%22%20y2%3D%22243.8984%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22243.8984%22%20y2%3D%22256.8984%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22256.8984%22%20y2%3D%22256.8984%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C252.8984%2C82.5%2C256.8984%2C92.5%2C260.8984%2C88.5%2C256.8984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2252%22%20x%3D%2288.5%22%20y%3D%22238.8325%22%3E%26%2322810%3B%26%2320184%3B%26%2336864%3B%26%2327454%3B%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23000000%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2210%22%20x2%3D%22289%22%20y1%3D%22272.8984%22%20y2%3D%22272.8984%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2211%22%20font-weight%3D%22bold%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%2215%22%20y%3D%22283.1089%22%3E%5B%26%2335746%3B%26%2321333%3B%26%2326410%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%5D%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2281.5%22%20x2%3D%22123.5%22%20y1%3D%22307.8359%22%20y2%3D%22307.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22123.5%22%20x2%3D%22123.5%22%20y1%3D%22307.8359%22%20y2%3D%22320.8359%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2282.5%22%20x2%3D%22123.5%22%20y1%3D%22320.8359%22%20y2%3D%22320.8359%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2292.5%2C316.8359%2C82.5%2C320.8359%2C92.5%2C324.8359%2C88.5%2C320.8359%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22117%22%20x%3D%2288.5%22%20y%3D%22302.77%22%3E%26%2325191%3B%26%2334892%3B%26%2325903%3B%26%2320184%3B%26%2325104%3B%26%2321151%3B%26%2330340%3B%26%2336923%3B%26%2336753%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E)

















### 如何处理多付？











多付了怎么办？退款呗。原路把钱给用户退回去。比如微信支付，直接调用它的退款的接口就行了。











但是因为这里是和资金相关，并且是和退款有关，比较敏感，并且还要和外部机构交互，所以我们需要记录一些退款相关的信息。所以我们定义了一个退款单的模型，用来记录退款的信息。













![img](https://cdn.nlark.com/yuque/0/2024/jpeg/5378072/1726641867911-e07182f6-2f99-46f7-ad36-6d358d66b1a0.jpeg)











具体的代码实现如下：





```
 private void doChargeBack(PaySuccessEvent paySuccessEvent) {        //组装退款参数        RefundCreateRequest refundCreateRequest = new RefundCreateRequest();        refundCreateRequest.setIdentifier(paySuccessEvent.getChannelStreamId());        refundCreateRequest.setMemo(REFUND_MEMO_PREFIX + paySuccessEvent.getChannelStreamId());        refundCreateRequest.setPayOrderId(paySuccessEvent.getPayOrderId());        refundCreateRequest.setRefundAmount(paySuccessEvent.getPaidAmount());        refundCreateRequest.setRefundChannel(paySuccessEvent.getPayChannel());        //创建退款单        RefundOrder refundOrder = refundOrderService.create(refundCreateRequest);        Assert.notNull(refundOrder, () -> new BizException(PayErrorCode.REFUND_CREATE_FAILED));
        //异步进行退款执行，失败了交给定时任务重试        Thread.ofVirtual().start(() -> {            RefundChannelRequest refundChannelRequest = new RefundChannelRequest();            refundChannelRequest.setRefundOrderId(refundOrder.getRefundOrderId());            refundChannelRequest.setPaidAmount(MoneyUtils.yuanToCent(refundOrder.getPaidAmount()));            refundChannelRequest.setPayChannelStreamId(refundOrder.getPayChannelStreamId());            refundChannelRequest.setPayOrderId(refundOrder.getPayOrderId());            refundChannelRequest.setRefundAmount(MoneyUtils.yuanToCent(refundOrder.getApplyRefundAmount()));            refundChannelRequest.setRefundReason(refundOrder.getMemo());            //调用支付渠道进行退款            RefundChannelResponse refundChannelResponse = payChannelServiceFactory.get(paySuccessEvent.getPayChannel()).refund(refundChannelRequest);
            if (refundChannelResponse.getSuccess()) {                //调用成功后，更新退款单状态到 PAYING                refundOrderService.paying(refundOrder.getRefundOrderId());            }        });    }
Java
```











并在退款成功后，渠道会有回调通知，接收到通知后，推进退款单和支付单状态：











```
@Transactional(rollbackFor = Exception.class)public boolean refundSuccess(RefundSuccessEvent refundSuccessEvent) {    RefundOrder refundOrder = refundOrderService.queryByOrderId(refundSuccessEvent.getRefundOrderId());    if (refundOrder.isRefunded()) {        return true;    }
    boolean refundResult = payOrderService.refundSuccess(refundSuccessEvent)            && refundOrderService.refundSuccess(refundSuccessEvent);
    Assert.isTrue(refundResult, () -> new BizException(PayErrorCode.REFUND_SUCCESS_NOTICE_FAILED));
    return true;}
```
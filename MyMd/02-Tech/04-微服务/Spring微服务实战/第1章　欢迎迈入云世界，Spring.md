# 第1章　欢迎迈入云世界，Spring

本章主要内容

● 了解微服务架构

● 了解企业采用微服务的原因

● 使用Spring、Spring Boot和Spring Cloud来搭建微服务

● 了解云的概念和基于云的计算模型

实现新架构不是一件容易的事情，它带来了许多挑战，如应用程序可伸缩性、服务发现、监控、分布式跟踪、安全性、管理等。本书将介绍Spring中的微服务世界，讲解如何应对所有这些挑战，并展示将微服务应用于业务应用程序的权衡。你将学习如何使用诸如Spring Cloud、Spring Boot、Swagger、Docker、Kubernetes、ELK（Elasticsearch、Logstash和Kibana）、Stack、Grafana、Prometheus等技术来构建微服务应用程序。

Spring Boot和Spring Cloud为Java开发人员提供了一条从构建传统的单体的Spring应用到构建可以部署在云端的微服务应用的平滑迁移路径。本书使用实际的例子、图表和描述性的文本，提供了如何实现微服务架构的更多细节。

最后，你将学习如何实现诸如客户端负载均衡、动态伸缩、分布式跟踪等技术和技巧，以使用Spring Boot和Spring Cloud创建灵活、新式和自主的基于微服务的业务应用程序。通过应用Kubernetes、Jenkins和Docker等技术，你还可以创建自己的构建/部署管道，以实现业务中的持续交付和集成。

## 1.1　微服务架构的演进

软件架构是指建立软件组件之间的结构、操作和交互的所有基本部分。本书解释了如何创建一个微服务架构，该架构由松耦合的软件服务组成，这些软件服务执行少量定义良好的任务，并通过网络使用消息进行通信。我们首先考虑一下微服务和其他一些常见架构之间的区别。

### 1.1.1　n层架构

一种常见的企业架构类型是多层或n层架构。通过这种设计，应用程序被划分为多个层，每个层都有自己的职责和功能，如用户界面（UI）、服务、数据、测试等。例如，当你创建应用程序时，你先为UI创建一个特定的项目或解决方案，然后为服务创建一个项目或解决方案，再为数据层创建一个项目或解决方案，以此类推。最后，你将拥有几个项目，将这些项目组合起来，创建一个完整的应用程序。对于大型企业系统，n层架构应用程序有许多优点，包括：

●n层架构应用程序提供了良好的关注点分离，使得人们可以分别考虑用户界面、数据和业务逻辑等领域；

● 团队很容易在n层架构应用程序的不同组件上独立工作；

● 因为这是一个易于理解的企业架构，所以为n层架构项目找到熟练的开发人员相对容易。n层架构应用程序也有缺点，例如：

● 当你想要进行更改时，必须停止并重新启动整个应用程序；

● 消息往往在各层之间上下传递，这可能是低效的；

● 一旦部署，重构一个大型的n层架构应用程序可能会很困难。

虽然我们在本书中讨论的一些主题与n层架构应用程序直接相关，但我们将更直接地关注微服务与另一种常见架构（通常称为单体架构）的区别。

### 1.1.2　什么是单体架构

许多中小型基于Web的应用程序都是使用单体架构风格构建的。在单体架构中，应用程序作为【单个可部署的软件制品】交付。所有用户界面、业务和数据库访问逻辑都打包到一个唯一的应用程序中，并部署到应用程序服务器。图1-1显示了这个应用程序的基本架构。

虽然应用程序可能是作为单个工作单元部署的，但经常会有多个开发团队在一个应用程序上工作。每个开发团队负责应用程序的不同部分，并且他们经常用自己的功能部件来服务特定的客户。例如，想象一个场景，我们有一个内部定制的客户关系管理（CRM）应用，它涉及多个团队之间的合作，包括UI/UX团队、客户团队、数据仓库团队以及金融从业者等。

尽管微服务架构的支持者有时会否定单体应用程序，但单体应用程序通常是一个很好的选择。与n层或微服务等更复杂的架构相比，单体应用程序更容易构建/部署。如果用例定义良好并且不太可能改变，那么从单体应用程序开始可能是一个很好的决定。

然而，当应用程序的规模和复杂性开始增加时，单体应用程序可能会变得难以管理。对单体应用程序的每一个更改都可能对应用程序的其他部分产生级联效应，这可能会使应用程序变得耗时且代价高昂，特别是在生产系统中。我们有的第三个选择——微服务架构，提供了更大的灵活性和可维护性。

![img](https://cdn.nlark.com/yuque/0/2024/png/26349101/1729582601203-11b5d4a3-b30e-406c-9f7c-7becffec0b60.png)

### 1.1.3　什么是微服务

微服务的概念最初悄悄蔓延到软件开发社区中，是作为对尝试（在技术上和组织上）扩大大型单体应用程序所面临的诸多挑战的直接回应。微服务是【**一种小型的、松耦合的分布式服务**】。微服务允许你将一个大型的应用分解为具有狭义职责定义的便于管理的组件。微服务通过将一个大型代码库分解为多个精确定义的小型代码库，帮助解决了大型代码库中传统的复杂问题。

对微服务的思考需要围绕两个关键概念展开：分解（decomposing）和分离（unbundling）。应用程序的功能应该完全彼此独立。如果我们以前面提到的CRM应用程序为例，将其分解为微服务，那么它看起来可能像图1-2所示的样子。

![img](https://cdn.nlark.com/yuque/0/2024/png/26349101/1729582635845-c3edc130-32a2-416c-9b78-59eeecc65731.png)

图1-2显示了每个团队是如何完全拥有自己的服务代码和服务基础设施的。他们可以彼此独立地去构建、部署和测试，因为他们的代码、源代码控制存储库和基础设施（应用服务器和数据库）现在是完全独立于应用的其他部分的。总的来说，微服务架构具有以下特征。

● 应用程序逻辑被分解为【**具有定义明确的、协调的职责边界的细粒度组件**】。

● 每个组件都有一个小的职责领域，并且完全独立部署。单个微服务对业务域的某一部分负责。

● 微服务采用【**HTTP这样的轻量级通信协议**】和【**JSON（JavaScript Object Notation，JavaScript对象表示法）**】，在服务消费者和服务提供者之间进行数据交换。

● 服务的底层采用什么技术实现并没有什么影响，因为微服务应用程序始终使用技术中立的格式（JSON是最常见的）进行通信。这意味着使用微服务方法构建的应用程序能够使用多种编程语言和技术进行构建。

● 微服务利用其【**小、独立和分布式的性质**】，使组织拥有具有明确责任领域的更小型开发团队。这些团队可能为同一个目标工作，如交付一个应用程序，但是每个团队只负责他们在做的服务。

![img](https://cdn.nlark.com/yuque/0/2024/png/26349101/1729582682907-e6248e34-f35d-41dd-b5c8-67b097e3c129.png)

### 1.1.4　为什么要改变构建应用的方式

习惯于为当地市场服务的公司突然发现，他们可以接触到全球的客户群，不过，更大的全球客户群也带来了全球竞争。更多的竞争影响了开发人员构建应用程序的方式。

●  【**复杂性**】上升。客户期望一个组织的所有部门都知道他们是谁。与单个数据库通信并且不与其他应用程序集成的“孤立的”应用程序已不再是常态。如今，应用程序需要与多个服务和数据库进行通信，这些服务和数据不仅位于公司数据中心内，还位于外部互联网服务供应商内。

●  客户期待【**更快速的交付**】。客户不想再等软件包的下一个年度版本了。相反，他们期望一个软件产品中的各个功能是分开的，以便新功能在几周（甚至几天）内即可快速发布。

●  客户还要求【**可靠的性能和可伸缩性**】。全球性的应用程序使预测应用程序能处理多少事务以及何时会到达该事务量变得非常困难。应用程序需要跨多个服务器快速扩大，然后在事务量高峰过去之后无缝收缩。

●  客户期望他们的应用程序可用。因为客户与竞争对手之间只有点击一下鼠标的距离，所以企业的应用程序必须具有高度的弹性。应用程序中某个部分的故障或问题不应该导致整个应用程序崩溃。为了满足这些期望，作为应用开发人员，我们不得不接受这样一个不可思议的的东西：要构建高度可伸缩的高度冗余的应用程序，我们需要将应用程序分解成可以互相独立构建和部署的小型服务。如果将应用程序“分解”为较小的服务，并将它们从单体制品中转移出来，那么就可以构建具有下面这些特性的系统。

●  灵活性——可以将解耦的服务进行组合和重新安排，以快速交付新的功能。一个正在使用的代码单元越小，更改越不复杂，测试部署代码所需的时间越短。

●  有弹性——解耦的服务意味着应用程序不再是单个“泥浆球”，其中【**一部分应用程序的降级**】会导致整个应用程序失败。故障可以限制在应用程序的一小部分中，并在整个应用程序遇到中断之前被控制。这也使应用程序在出现不可恢复的错误的情况下能够优雅地降级。

●  可伸缩性——解耦的服务可以轻松地跨多个服务器进行水平分布，从而可以适当地对功能 / 服务进行伸缩。单体应用程序中的所有逻辑是交织在一起的，即使只有一小部分应用程序是瓶颈，整个应用程序也需要扩展。小型服务的扩展是局部的，成本效益更高。

为此，当我们开始讨论微服务时，请记住：

小型的、简单的、解耦的服务 = 可伸缩的、弹性的、灵活的应用程序

系统和组织本身可以从微服务方法中获益——理解这一点是很重要的。为了在组织中获益，我们可以反向应用康威定律（Conway’s law）。这个定律指出了几点可以改善公司内部沟通和结构的措施。

康威定律（由Melvin R. Conway在1968年4月的文章“How do Committees Invent”中首次提到）指出“设计系统的组织其产生的设计等价于组织间的沟通结构”。基本上，它所表明的是，团队内部以及与其他团队之间的沟通方式直接反映在他们生产的代码中。

如果我们反向应用康威定律，也称为逆康威策略（inverse Conway maneuver），并基于微服务架构设计公司结构，那么通过创建松耦合的自治团队来实现微服务，就能改善应用程序的通信、稳定性和组织结构。

## 1.2　使用Spring开发微服务

Spring已经成为构建基于Java的应用程序的最流行的开发框架。Spring的核心是建立在依赖注入的概念上的。依赖注入框架（dependency injection framework）允许你通过约定（以及注解）将应用程序中对象之间的关系外部化，而不是在对象内部彼此硬编码实例化代码，这使开发人员能更高效地管理大型Java项目。Spring在应用程序的不同的Java类之间充当中间人，管理着它们的依赖关系。Spring本质上就是让你像玩乐高积木一样将自己的代码组装在一起。

Spring框架令人印象深刻的地方在于它能够与时俱进并进行自我改造。Spring开发人员很快发现，许多开发团队正在从将应用程序的展现、业务和数据访问逻辑打包在一起并部署为单个制品的单体应用程序模型中迁移，转向高度分布式的模型，在这种模型中，小型服务可以快速部署到云端。为了响应这种转变，Spring开发人员启动了两个项目，即Spring Boot和Spring Cloud。

Spring Boot是对Spring框架理念重新思考的结果。虽然Spring Boot包含了Spring的核心特性，但它剥离了Spring中的许多“企业”特性，而提供了一个基于Java的、面向REST （Representational State Transfer，表征状态转移）的微服务框架。只需一些简单的注解，Java开发者就能够快速构建一个可打包和部署的REST服务，这个服务并不需要外部的应用容器。

```
注意　虽然本书会在第3章中更详细地介绍REST，但REST背后的核心概念是，服务应该使用HTTP动词（GET、POST、PUT和DELETE）来代表服务中的核心操作，并且应该使用轻量级的面向Web的数据序列化协议（如JSON）来从服务请求数据和从服务接收数据。
```

Spring Boot的主要特性如下。

● 嵌入式Web服务器，用于避免应用程序部署的复杂性：Tomcat（默认）、Jetty或Undertow。这是Spring Boot的一个基本概念，所选的Web服务器是可部署JAR文件的一部分。对于Spring Boot应用程序，部署应用程序的唯一必要条件是在服务器上安装Java。

● 快速启动项目的建议配置（各种starter项目）。

● 尽可能地自动配置Spring功能。

● 可供生产使用的广泛特性（如度量、安全性、状态验证、外部化配置等）。使用Spring Boot对我们的微服务有以下好处。

● 减少开发时间，提高效率和生产力。

● 提供嵌入式HTTP服务器来运行Web应用程序。

● 避免编写很多样板式代码。

● 促进与Spring生态系统的集成（包括Spring Data、Spring Security、Spring Cloud等）。

● 提供一套各种开发插件。

在构建基于云的应用程序时，微服务已经成为十分常见的架构模式之一，因此Spring开发人员社区为开发人员提供了Spring Cloud。Spring Cloud框架使得将微服务实施和部署到私有云或公有云变得更加简单。Spring Cloud在一个公共框架中封装了多个流行的云管理微服务框架，并且让这些技术的使用和部署像为代码添加注解一样简便。第2章将介绍Spring Cloud中的不同组件。

## 1.3　我们在构建什么

本书提供了一个使用Spring Boot、Spring Cloud和其他有用的现代技术创建完整的微服务架构的分步指南。图1-4展示了我们将在本书中使用的一些服务和技术集成的高层概述。

图1-4描述了在我们将要创建的微服务架构中，更新和检索组织信息的客户端请求。要启动请求，客户端首先需要使用Keycloak进行身份验证以获得访问令牌。一旦获得令牌，客户端就向Spring Cloud API Gateway发出请求。API网关服务是我们整个架构的入口点。该服务将与Eureka服务发现进行通信，以检索组织和许可证服务的位置，然后调用特定的微服

一旦请求到达组织服务，该服务将通过Keycloak验证访问令牌，以查看令牌是否有效以及用户是否有权继续该过程。确认令牌有效后，组织服务将从组织数据库更新和检索其信息，并将这些信息作为HTTP响应发送回客户端。作为另一条路，更新完组织信息后，组织服务将向Kafka主题添加一条消息，以便许可证服务可以知道这一更改。

![img](https://cdn.nlark.com/yuque/0/2024/png/26349101/1729583351763-54598b5b-0a39-4c9d-b8e3-4abc645b3182.png)

图1-4　我们将在本书中使用的服务和技术的高层概述

当消息到达许可证服务后，Redis会在Redis的内存数据库中存储特定信息。在整个过程中，此架构将使用来自Zipkin的分布式跟踪，并使用Elasticsearch和Logstash来管理和显示日志，同时使用Spring Boot Actuator、Prometheus和Grafana来公开和显示应用程序度量。

随着我们继续向前探索，我们将看到诸如Spring Boot、Spring Cloud、Elasticsearch、Logstash、Kibana、Prometheus、Grafana和Kafka等主题。所有这些技术听起来可能很复杂，但是随着本书的深入，我们将看到如何创建和集成构成图1-4中框架的不同组件。

## 1.4　本书涵盖什么内容

本书的范围很广，它涵盖了从基本定义到创建微服务架构的更复杂实现的所有内容。

### 1.4.1　在本书中你会学到什么

本书是关于使用各种Spring项目（如Spring Boot和Spring Cloud）构建基于微服务架构的应用程序的，这些应用程序可以部署到公司内运行的私有云或亚马逊、谷歌和微软等运行的公有云上。本书涵盖以下主题。

● 微服务是什么、最佳实践，以及构建基于微服务的应用程序的设计考虑因素。

● 什么时候不应该构建基于微服务的应用程序。

● 如何使用Spring Boot框架来构建微服务。

● 支持微服务应用程序的核心运维模式，特别是基于云的应用程序。

● Docker是什么，如何将它与基于微服务的应用程序集成。

● 如何使用Spring Cloud来实现本章稍后描述的运维模式。

● 如何创建应用程序度量，并在监控工具中可视化这些度量。

● 如何利用Zipkin和Sleuth实现分布式跟踪。

● 如何使用ELK技术栈来管理应用程序日志。

● 如何利用已学的知识，构建一个部署管道，在本地将服务部署到内部管理的私有云或公有云厂商所提供的环境中。

读完本书，你将具备构建和部署Spring Boot微服务所需的知识，明白实施微服务的关键设计决策，了解如何将服务配置管理、服务发现、消息传递、日志记录和跟踪以及安全性结合在一起，以交付一个健壮的微服务环境，最后你还会看到如何使用不同的技术部署微服务。

### 1.4.2　为什么本书与你有关

我猜你能读到这里是因为：

● 你是一名Java开发人员或对Java有很深入的理解；

● 你拥有Spring背景；

● 你对学习如何构建基于微服务的应用程序感兴趣；

● 你对如何使用微服务来构建基于云的应用程序感兴趣；

● 你想知道Java和Spring是否是用于构建基于微服务的应用程序的相关技术；

● 你想知道实现微服务架构的前沿技术；

● 你有兴趣了解如何将基于微服务的应用部署到云上。

本书提供了一份在Java中实现微服务架构的详细指南。书中既有描述性和可视化信息，又有大量实际操作的代码示例，为如何使用不同Spring项目（如Spring Boot和Spring Cloud）的最新版本实现微服务架构提供了编程指南。

此外，本书介绍了微服务模式、最佳实践，以及与这种类型的架构相关联的基础设施技术，模拟了真实世界的应用程序开发环境。让我们转移一下注意力，使用Spring Boot构建一个简单的微服务。

## 1.5　云和基于微服务的应用程序

在本节中，我们将了解如何使用Spring Boot创建微服务，以及为什么云与基于微服务的应用程序有关。

### 1.5.1　使用Spring Boot来构建微服务